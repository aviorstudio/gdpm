---
export const prerender = false;

import RootLayout from '../../layouts/RootLayout.astro';
import Card from '../../components/Card.astro';
import Splash from '../../components/Splash.astro';
import Input from '../../components/Input.astro';
import { getSessionFromCookies } from '../../lib/auth';
import { usernamesDto } from '../../lib/dtoService';
import { supabase } from '../../lib/supabase';

type UsernameRecord = {
  username_display: string | null;
  profile_id: string | null;
  org_id: string | null;
};

const safeDecodeURIComponent = (value: string) => {
  try {
    return decodeURIComponent(value);
  } catch {
    return value;
  }
};

const normalizeUsername = (value: string) => value.trim().toLowerCase();

const usernameParamRaw = Astro.params.username ?? '';
const usernameParam = safeDecodeURIComponent(usernameParamRaw);
const usernameNormal = normalizeUsername(usernameParam);

const publicPath = Astro.url.pathname.replace(/\/settings\/?$/, '') || '/';

const session = await getSessionFromCookies(Astro.cookies);
if (!session) {
  return Astro.redirect(publicPath);
}

const profileId = session.user?.id ?? '';
if (!profileId || !usernameNormal) {
  return Astro.redirect(publicPath);
}

const { data: usernameRow, error: usernameError } = await usernamesDto.getByUsernameNormal(supabase, usernameNormal);
if (usernameError || !usernameRow) {
  return Astro.redirect(publicPath);
}

const usernameRecord = usernameRow as UsernameRecord;
if (!usernameRecord.profile_id || usernameRecord.profile_id !== profileId) {
  return Astro.redirect(publicPath);
}

const email = session.user?.email ?? '';
const usernameDisplay = usernameRecord.username_display || usernameParam;
---

<RootLayout>
  <Splash title="Settings" subtitle="Manage your profile details. Saving changes isnâ€™t wired up yet." />

  <Card class="space-y-5">
    <div class="grid gap-4 md:grid-cols-2">
      <Input
        label="Display name"
        name="name"
        autocomplete="name"
        placeholder="Your name"
        type="text"
        value={usernameDisplay}
      />

      <Input
        label="Username"
        name="username"
        autocomplete="username"
        placeholder="your-handle"
        type="text"
        value={usernameDisplay}
      />

      <Input
        label="Email"
        name="email"
        autocomplete="email"
        type="email"
        value={email}
        readonly
        class="bg-slate-50"
        wrapperClass="md:col-span-2"
      />
    </div>

    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <a
        class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-800 shadow-sm transition hover:bg-slate-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-400"
        href={publicPath}
      >
        Back
      </a>
      <button
        class="inline-flex items-center justify-center rounded-xl bg-sky-600 px-4 py-3 text-sm font-semibold text-white shadow-sm opacity-60"
        type="button"
        disabled
      >
        Save changes
      </button>
    </div>

    <form class="flex justify-end" action="/api/auth/signout">
      <button
        class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-semibold text-slate-800 shadow-sm transition hover:bg-slate-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-400"
        type="submit"
      >
        Sign out
      </button>
    </form>
  </Card>
</RootLayout>
