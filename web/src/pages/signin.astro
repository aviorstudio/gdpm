---
export const prerender = false;

import AuthLayout from '../layouts/AuthLayout.astro';
import {
	readSessionFromCookies,
	signInWithIdentifier,
} from '../services/supabase';

const earlySession = readSessionFromCookies(Astro.cookies);
if (earlySession) {
	return Astro.redirect('/');
}

let status = '';
let tone: 'muted' | 'error' | 'success' = 'muted';

if (Astro.request.method === 'POST') {
	const formData = await Astro.request.formData();
	const identifier = String(formData.get('identifier') ?? '').trim();
	const password = String(formData.get('password') ?? '').trim();

	if (!identifier || !password) {
		status = 'Email or username and password are required.';
		tone = 'error';
	} else {
		const { error } = await signInWithIdentifier(Astro.cookies, identifier, password);
		if (error) {
			status = error;
			tone = 'error';
		} else {
			return Astro.redirect('/');
		}
	}
}

const laterSession = readSessionFromCookies(Astro.cookies);
if (laterSession) {
	return Astro.redirect('/');
}
---

<AuthLayout status={status} tone={tone} mode="signin">
	<label class="field">
		<span>Email or username</span>
		<input name="identifier" autocomplete="username" />
	</label>

	<label class="field">
		<span>Password</span>
		<input name="password" type="password" autocomplete="current-password" />
	</label>
</AuthLayout>
