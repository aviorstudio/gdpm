---
export const prerender = false;

import { getSessionFromCookies } from '../lib/auth';
import { usernamesDto } from '../lib/dtoService';
import { supabase } from '../lib/supabase';

const session = await getSessionFromCookies(Astro.cookies);
if (!session) {
  return Astro.redirect('/signin');
}

const profileId = session.user?.id ?? '';
if (!profileId) {
  return Astro.redirect('/signin');
}

const { data: usernamesData } = await usernamesDto.getByProfileId(supabase, profileId);
const usernameDisplay = (usernamesData as Array<{ username_display?: string | null }> | null)?.[0]?.username_display;

if (!usernameDisplay) {
  return Astro.redirect('/');
}

return Astro.redirect(`/${encodeURIComponent(usernameDisplay)}/account`);
---

