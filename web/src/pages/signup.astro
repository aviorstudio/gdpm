---
export const prerender = false;

import AuthLayout from '../layouts/AuthLayout.astro';
import AuthInput from '../components/AuthInput.astro';
import { confirmSignUpWithCode, readSessionFromCookies, signUpWithProfile } from '../services/supabase';

const earlySession = readSessionFromCookies(Astro.cookies);
if (earlySession) {
  return Astro.redirect('/');
}

const search = Astro.url.searchParams;
let status = search.get('status') ?? '';
const toneParam = search.get('tone');
let tone: 'muted' | 'error' | 'success' =
  toneParam === 'error' ? 'error' : toneParam === 'success' ? 'success' : 'muted';

let showVerification = false;
let pendingUsername = '';
let pendingEmail = '';
let formUsername = '';
let formEmail = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const step = String(formData.get('step') ?? 'create');

  if (step === 'verify') {
    pendingUsername = String(formData.get('username') ?? '').trim();
    pendingEmail = String(formData.get('email') ?? '').trim();
    formUsername = pendingUsername;
    formEmail = pendingEmail;
    showVerification = true;

    const token = String(formData.get('token') ?? '').trim();
    if (!pendingUsername || !pendingEmail || !token) {
      status = 'Email, username, and code are required.';
      tone = 'error';
    } else {
      const { error } = await confirmSignUpWithCode(Astro.cookies, pendingUsername, pendingEmail, token);
      if (error) {
        status = error;
        tone = 'error';
      } else {
        return Astro.redirect('/');
      }
    }
  } else {
    formUsername = String(formData.get('username') ?? '').trim();
    formEmail = String(formData.get('email') ?? '').trim();
    const password = String(formData.get('password') ?? '').trim();

    if (!formUsername || !formEmail || !password) {
      status = 'Username, email, and password are required.';
      tone = 'error';
    } else {
      const result = await signUpWithProfile(Astro.cookies, formUsername, formEmail, password);
      if (result.error) {
        status = result.error;
        tone = 'error';
      } else if (result.session) {
        return Astro.redirect('/');
      } else {
        status = result.notice ?? 'Check your email for the verification code.';
        tone = 'success';
        showVerification = true;
        pendingUsername = formUsername;
        pendingEmail = formEmail;
      }
    }
  }
}
---

<AuthLayout status={status} tone={tone} mode="signup" action="/signup">
  <input type="hidden" name="step" value="create" />
  <AuthInput
    label="Username"
    name="username"
    autocomplete="username"
    minlength="3"
    maxlength="32"
    value={formUsername}
  />

  <AuthInput label="Email" name="email" type="email" autocomplete="email" value={formEmail} />

  <AuthInput
    label="Password"
    name="password"
    type="password"
    minlength="6"
    autocomplete="new-password"
  />

  <div slot="overlay">
    {
      showVerification && (
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 px-4">
          <div class="w-full max-w-md rounded-2xl border border-slate-200 bg-white p-6 text-left shadow-xl">
            <h2 class="text-lg font-semibold text-slate-900">Confirm your email</h2>
            <p class="mt-1 text-sm text-slate-600">
              Enter the verification code we sent to <span class="font-semibold text-slate-900">{pendingEmail}</span>.
            </p>

            <form method="post" action="/signup" class="mt-5 space-y-4">
              <input type="hidden" name="step" value="verify" />
              <input type="hidden" name="username" value={pendingUsername} />
              <input type="hidden" name="email" value={pendingEmail} />

              <AuthInput
                label="Verification code"
                name="token"
                inputmode="numeric"
                autocomplete="one-time-code"
                placeholder="12345678"
                required
              />

              {
                tone === 'error' && status && (
                  <p class="text-sm font-medium text-red-600">
                    {status}
                  </p>
                )
              }

              <div class="flex flex-col gap-3 sm:flex-row sm:justify-end">
                <a
                  class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-800 shadow-sm transition hover:bg-slate-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-400"
                  href="/signup"
                >
                  Cancel
                </a>
                <button
                  class="inline-flex items-center justify-center rounded-xl bg-sky-600 px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-600"
                  type="submit"
                >
                  Confirm
                </button>
              </div>
            </form>
          </div>
        </div>
      )
    }
  </div>
</AuthLayout>
