---
export const prerender = false;

import AuthLayout from '../layouts/AuthLayout.astro';
import {
  readSessionFromCookies,
  signUpWithProfile,
} from '../services/supabase';

const earlySession = readSessionFromCookies(Astro.cookies);
if (earlySession) {
  return Astro.redirect('/');
}

let status = '';
let tone: 'muted' | 'error' | 'success' = 'muted';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const username = String(formData.get('username') ?? '').trim();
  const email = String(formData.get('email') ?? '').trim();
  const password = String(formData.get('password') ?? '').trim();

  if (!username || !email || !password) {
    status = 'Username, email, and password are required.';
    tone = 'error';
  } else {
    const { error } = await signUpWithProfile(Astro.cookies, username, email, password);
    if (error) {
      status = error;
      tone = 'error';
    } else {
      return Astro.redirect('/');
    }
  }
}

const laterSession = readSessionFromCookies(Astro.cookies);
if (laterSession) {
  return Astro.redirect('/');
}

const inputClasses =
  'w-full rounded-xl border border-slate-200 bg-white px-3 py-3 text-base text-slate-900 shadow-sm outline-none transition focus:border-sky-500 focus:ring-2 focus:ring-sky-200';
---

<AuthLayout status={status} tone={tone} mode="signup">
  <label class="grid gap-2 text-sm font-medium text-slate-800">
    <span>Username</span>
    <input
      class={inputClasses}
      name="username"
      autocomplete="username"
      minlength="3"
      maxlength="32"
    />
  </label>

  <label class="grid gap-2 text-sm font-medium text-slate-800">
    <span>Email</span>
    <input class={inputClasses} name="email" type="email" autocomplete="email" />
  </label>

  <label class="grid gap-2 text-sm font-medium text-slate-800">
    <span>Password</span>
    <input
      class={inputClasses}
      name="password"
      type="password"
      minlength="6"
      autocomplete="new-password"
    />
  </label>
</AuthLayout>
