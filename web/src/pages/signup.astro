---
export const prerender = false;

import AuthLayout from '../layouts/AuthLayout.astro';
import AuthInput from '../components/AuthInput.astro';
import {
  readSessionFromCookies,
  signUpWithProfile,
} from '../services/supabase';

const earlySession = readSessionFromCookies(Astro.cookies);
if (earlySession) {
  return Astro.redirect('/');
}

let status = '';
let tone: 'muted' | 'error' | 'success' = 'muted';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const username = String(formData.get('username') ?? '').trim();
  const email = String(formData.get('email') ?? '').trim();
  const password = String(formData.get('password') ?? '').trim();

  if (!username || !email || !password) {
    status = 'Username, email, and password are required.';
    tone = 'error';
  } else {
    const { error, notice } = await signUpWithProfile(Astro.cookies, username, email, password);
    if (error || notice) {
      status = error;
      tone = 'error';
      if (notice) {
        status = notice;
        tone = 'success';
      }
    } else {
      return Astro.redirect('/');
    }
  }
}

const laterSession = readSessionFromCookies(Astro.cookies);
if (laterSession) {
  return Astro.redirect('/');
}
---

<AuthLayout status={status} tone={tone} mode="signup">
  <AuthInput
    label="Username"
    name="username"
    autocomplete="username"
    minlength="3"
    maxlength="32"
  />

  <AuthInput label="Email" name="email" type="email" autocomplete="email" />

  <AuthInput
    label="Password"
    name="password"
    type="password"
    minlength="6"
    autocomplete="new-password"
  />
</AuthLayout>
